import sys
import zlib
import hashlib
import os

def main():
    fname = sys.argv[1]
    tempname = fname

    fp = open(tempname, 'rb')
    buf = fp.read()
    fp.close()

    buf2 = zlib.compress(buf)

    buf3 = ''
    for c in buf2:
        buf3 += chr(ord(chr(c)) ^ 0xFF)

    buf4 = 'KAVM' + buf3 #무결성 체크

    f = buf4
    for i in range(3):
        md5 = hashlib.md5()
        md5.update(f.encode('utf-8'))
        f = md5.hexdigest()

    buf4 += f

    kmd_name = fname.split('.')[0] + '.kmd'
    fp = open(kmd_name, 'wb')
    fp.write(buf4.encode('utf-8'))
    fp.close()

    print(fname, "->", kmd_name)

if __name__ == "__main__":
    main()