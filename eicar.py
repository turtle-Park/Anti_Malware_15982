import os
import hashlib


class KavMain:
    def init(self, plugins_path):
        #엔진 초기화
        #인자 (plugins_path) - 플로그인 엔진 위치
        #return 성공시 - 0, 그 외 - 실패

        return 0

    def uninit(self):
        #엔진 종료
        #return 성공시 - 0, 그외 - 실패

        return 0

    def scan(self, filehandle, filename):
        #악성코드 검사
        #인자 값 : filehandle - 파일 핸들
        #      : filename - 파일 이름
        #return (악성코드 발견 여부, 악성코드 이름, 악성코드 ID)등

        try:
            mm = filehandle

            size = os.path.getsize(filename)
            if size == 68:      #EICAR Test 악성코드와 크기 비교
                #일치시 MD5해시 계산
                m = hashlib.md5()
                m.update(mm[:68])
                fmd5 = m.hexdigest()
                print(fmd5)
                if fmd5 == '6a26cc095f9132549ae21ea4065899f6':
                    return True, 'EICAR-Test-File (not a virus)', 0

        except IOError:
            pass

        #악성코드 미발견시
        return False, '', -1

    def disinfect(self, filename, malware_id):
        #악성코드 치료
        #인자값 : filename     -파일이름
        #      : malware_id   -치료할 악성코드 ID
        #return 악성코드 치료 여부
        try:
            #악성코드 진달 결과 받은 ID 값이 0인가?
            if malware_id == 0:
                os.remove(filename)     #파일삭제
                return True             #치료 완료

        except IOError:
            pass
        return False

    def listvirus(self):
        #악성코드 리스트 제공
        #return 악성코드 목록
        vlist = list()
        vlist.append('EICAR-Test-File (not a Virus)')

        return vlist

    def getinfo(self):
        #엔진 주요 정보 제공
        #return 엔진 정보
        info = dict()
        info['author'] = "Turtle-Park"
        info['version'] = "1.0"
        info['title'] = "EICAR scan engine"
        info["kmd_name"] = "eicar"

        return info